# Alertmanager Configuration for INSA CRM Multi-Agent System
# Version: 1.0.0
# Created: October 29, 2025

# Global configuration
global:
  # Default SMTP configuration for email notifications
  smtp_from: 'insa-crm-alerts@insaing.com'
  smtp_smarthost: 'localhost:25'
  smtp_require_tls: false

  # Slack webhook URL (configure if using Slack)
  # slack_api_url: 'https://hooks.slack.com/services/YOUR/WEBHOOK/URL'

# Template files for custom notification formatting
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# Route tree for alert routing based on labels
route:
  # Default receiver for all alerts
  receiver: 'default-receiver'

  # Group alerts by these labels to avoid notification spam
  group_by: ['alertname', 'severity', 'component']

  # Wait this long to buffer alerts of the same group before sending
  group_wait: 30s

  # How long to wait before sending notification about new alerts added to an already firing group
  group_interval: 5m

  # How long to wait before re-sending a notification (for reminders)
  repeat_interval: 4h

  # Child routes for specific alert types
  routes:
    # Critical alerts - immediate notification, multiple channels
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 10s
      group_interval: 2m
      repeat_interval: 1h
      continue: true  # Also send to default receiver

    # Worker health alerts - high priority
    - match:
        component: worker
      receiver: 'worker-alerts'
      group_by: ['alertname', 'worker_name']
      group_wait: 30s
      repeat_interval: 2h

    # Database alerts - high priority
    - match:
        component: database
      receiver: 'database-alerts'
      group_wait: 15s
      repeat_interval: 1h

    # Circuit breaker alerts
    - match:
        component: circuit_breaker
      receiver: 'circuit-breaker-alerts'
      group_wait: 1m
      repeat_interval: 3h

    # Dead Letter Queue alerts
    - match:
        component: dlq
      receiver: 'dlq-alerts'
      group_wait: 2m
      repeat_interval: 6h

    # Infrastructure/system alerts
    - match:
        team: infrastructure
      receiver: 'infrastructure-alerts'
      group_wait: 5m
      repeat_interval: 12h

# Inhibition rules - suppress certain alerts when others are firing
inhibit_rules:
  # Inhibit worker-level alerts when multiple workers are down
  - source_match:
      alertname: 'MultipleWorkersDown'
    target_match:
      alertname: 'WorkerUnhealthy'
    equal: ['component']

  # Inhibit high error rate when circuit breaker is open (expected behavior)
  - source_match:
      alertname: 'CircuitBreakerOpen'
    target_match:
      alertname: 'HighErrorRate'
    equal: ['component']

  # Inhibit cache alerts when workers are down
  - source_match:
      alertname: 'WorkerUnhealthy'
    target_match:
      component: 'cache'
    equal: ['worker_type']

  # Inhibit DLQ growing when workers are unhealthy (expected)
  - source_match:
      alertname: 'WorkerUnhealthy'
    target_match:
      component: 'dlq'

# Receivers - notification destinations
receivers:
  # Default receiver - email to platform team
  - name: 'default-receiver'
    email_configs:
      - to: 'w.aroca@insaing.com'
        headers:
          Subject: '[INSA CRM] {{ .GroupLabels.severity | toUpper }}: {{ .GroupLabels.alertname }}'
        html: |
          <!DOCTYPE html>
          <html>
          <head>
            <style>
              body { font-family: Arial, sans-serif; }
              .alert { padding: 15px; margin: 10px 0; border-left: 4px solid; }
              .critical { border-color: #dc3545; background-color: #f8d7da; }
              .warning { border-color: #ffc107; background-color: #fff3cd; }
              .info { border-color: #17a2b8; background-color: #d1ecf1; }
              .resolved { border-color: #28a745; background-color: #d4edda; }
              h2 { margin-top: 0; }
              .label { display: inline-block; padding: 2px 8px; margin: 2px; background-color: #e9ecef; border-radius: 3px; font-size: 0.85em; }
            </style>
          </head>
          <body>
            <h1>INSA CRM Alert Notification</h1>
            {{ range .Alerts }}
            <div class="alert {{ .Labels.severity }}">
              <h2>{{ .Labels.alertname }}</h2>
              <p><strong>Summary:</strong> {{ .Annotations.summary }}</p>
              <p><strong>Description:</strong></p>
              <pre>{{ .Annotations.description }}</pre>

              <p><strong>Labels:</strong></p>
              {{ range .Labels.SortedPairs }}
                <span class="label">{{ .Name }}: {{ .Value }}</span>
              {{ end }}

              <p><strong>Started:</strong> {{ .StartsAt }}</p>
              {{ if .EndsAt }}<p><strong>Ended:</strong> {{ .EndsAt }}</p>{{ end }}

              {{ if .Annotations.runbook }}
              <p><strong>Runbook:</strong> <a href="{{ .Annotations.runbook }}">{{ .Annotations.runbook }}</a></p>
              {{ end }}
            </div>
            {{ end }}
          </body>
          </html>

  # Critical alerts - multiple notification channels
  - name: 'critical-alerts'
    email_configs:
      - to: 'w.aroca@insaing.com, platform-oncall@insaing.com'
        headers:
          Subject: 'ðŸš¨ [CRITICAL] INSA CRM: {{ .GroupLabels.alertname }}'
        send_resolved: true

    # Webhook for PagerDuty, Opsgenie, or custom integration
    webhook_configs:
      - url: 'http://localhost:8080/alerts/critical'
        send_resolved: true
        http_config:
          follow_redirects: true

    # Uncomment to enable Slack notifications
    # slack_configs:
    #   - channel: '#insa-crm-critical'
    #     title: 'ðŸš¨ CRITICAL: {{ .GroupLabels.alertname }}'
    #     text: '{{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
    #     send_resolved: true

  # Worker alerts
  - name: 'worker-alerts'
    email_configs:
      - to: 'w.aroca@insaing.com'
        headers:
          Subject: '[Worker Alert] {{ .GroupLabels.alertname }} - {{ .GroupLabels.worker_name }}'
        send_resolved: true

  # Database alerts
  - name: 'database-alerts'
    email_configs:
      - to: 'w.aroca@insaing.com, database-team@insaing.com'
        headers:
          Subject: '[Database Alert] {{ .GroupLabels.alertname }}'
        send_resolved: true

  # Circuit breaker alerts
  - name: 'circuit-breaker-alerts'
    email_configs:
      - to: 'w.aroca@insaing.com'
        headers:
          Subject: '[Circuit Breaker] {{ .GroupLabels.alertname }} - {{ .GroupLabels.breaker_name }}'
        send_resolved: true

  # DLQ alerts
  - name: 'dlq-alerts'
    email_configs:
      - to: 'w.aroca@insaing.com'
        headers:
          Subject: '[DLQ Alert] {{ .GroupLabels.alertname }} - {{ .GroupLabels.agent_type }}'
        send_resolved: true

  # Infrastructure alerts
  - name: 'infrastructure-alerts'
    email_configs:
      - to: 'w.aroca@insaing.com, infrastructure-team@insaing.com'
        headers:
          Subject: '[Infrastructure] {{ .GroupLabels.alertname }}'
        send_resolved: true

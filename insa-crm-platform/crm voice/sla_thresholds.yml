# INSA CRM Platform - SLA Thresholds Configuration
# Version: 1.0.0
# Created: October 29, 2025
# Purpose: Define Service Level Agreement targets for monitoring and reporting

# Global SLA Configuration
global:
  reporting_period: monthly  # monthly, quarterly, yearly
  measurement_window: 30d    # Time window for SLA calculations
  timezone: America/Bogota   # INSA Automation Corp timezone

  # SLA compliance levels
  compliance_levels:
    excellent: 99.9  # Green - Exceeds SLA
    good: 99.0       # Yellow - Meets SLA minimum
    poor: 95.0       # Orange - Below SLA
    critical: 90.0   # Red - Critical violation

# 1. AVAILABILITY SLAs
availability:
  # Overall platform uptime
  - name: "Platform Uptime"
    metric: "up"
    target: 99.9  # 99.9% uptime = 43.8 minutes downtime per month
    unit: "percent"
    severity: critical
    description: "Overall platform availability measured by successful health checks"
    calculation: |
      (successful_health_checks / total_health_checks) * 100
    breach_notification:
      - w.aroca@insaing.com
      - platform-oncall@insaing.com

  # Per-agent uptime
  - name: "Agent Worker Uptime"
    metric: "insa_worker_health_status"
    target: 99.9
    unit: "percent"
    severity: critical
    per_worker: true  # Track separately for each worker
    description: "Individual agent worker availability"
    calculation: |
      (time_worker_healthy / total_time) * 100
    breach_notification:
      - w.aroca@insaing.com

  # Critical component uptime
  - name: "Database Uptime"
    metric: "insa_database_up"
    target: 99.95  # Higher target for critical infrastructure
    unit: "percent"
    severity: critical
    description: "PostgreSQL database availability"
    calculation: |
      (successful_db_connections / total_db_connection_attempts) * 100

  - name: "Message Bus Uptime"
    metric: "insa_message_bus_up"
    target: 99.9
    unit: "percent"
    severity: critical
    description: "Agent message bus availability"

  - name: "Cache Uptime"
    metric: "insa_cache_up"
    target: 99.5  # Slightly lower - cache failures are recoverable
    unit: "percent"
    severity: high
    description: "Orchestrator cache availability"

# 2. PERFORMANCE SLAs
performance:
  # Response time SLAs
  - name: "API Response Time P50"
    metric: "insa_agent_request_duration_seconds"
    target: 2.0  # 2 seconds for median response
    unit: "seconds"
    severity: high
    percentile: 50
    description: "Median API response time (50th percentile)"
    calculation: |
      histogram_quantile(0.50,
        sum(rate(insa_agent_request_duration_seconds_bucket[5m])) by (le)
      )

  - name: "API Response Time P95"
    metric: "insa_agent_request_duration_seconds"
    target: 5.0  # 5 seconds for 95th percentile
    unit: "seconds"
    severity: critical
    percentile: 95
    description: "95th percentile API response time - 95% of requests faster than this"
    calculation: |
      histogram_quantile(0.95,
        sum(rate(insa_agent_request_duration_seconds_bucket[5m])) by (le)
      )
    breach_notification:
      - w.aroca@insaing.com

  - name: "API Response Time P99"
    metric: "insa_agent_request_duration_seconds"
    target: 15.0  # 15 seconds for 99th percentile
    unit: "seconds"
    severity: critical
    percentile: 99
    description: "99th percentile API response time - 99% of requests faster than this"
    calculation: |
      histogram_quantile(0.99,
        sum(rate(insa_agent_request_duration_seconds_bucket[5m])) by (le)
      )

  # Database performance
  - name: "Database Query Time P95"
    metric: "insa_database_operation_duration_seconds"
    target: 1.0  # 1 second for 95th percentile
    unit: "seconds"
    severity: high
    percentile: 95
    description: "95th percentile database query time"
    calculation: |
      histogram_quantile(0.95,
        sum(rate(insa_database_operation_duration_seconds_bucket[5m])) by (le)
      )

  - name: "Database Query Time P99"
    metric: "insa_database_operation_duration_seconds"
    target: 3.0  # 3 seconds for 99th percentile
    unit: "seconds"
    severity: critical
    percentile: 99
    description: "99th percentile database query time"

  # Message bus performance
  - name: "Message Processing Time P95"
    metric: "insa_message_bus_processing_duration_seconds"
    target: 2.0  # 2 seconds for message processing
    unit: "seconds"
    severity: high
    percentile: 95
    description: "95th percentile message processing time"

# 3. RELIABILITY SLAs
reliability:
  # Error rate SLAs
  - name: "API Error Rate"
    metric: "insa_agent_requests_total"
    target: 0.1  # <0.1% error rate
    unit: "percent"
    severity: critical
    description: "Percentage of failed API requests"
    calculation: |
      (sum(rate(insa_agent_requests_total{status="error"}[5m])) /
       sum(rate(insa_agent_requests_total[5m]))) * 100
    breach_notification:
      - w.aroca@insaing.com
      - platform-oncall@insaing.com

  - name: "API Timeout Rate"
    metric: "insa_agent_requests_total"
    target: 0.5  # <0.5% timeout rate
    unit: "percent"
    severity: high
    description: "Percentage of timed-out requests"
    calculation: |
      (sum(rate(insa_agent_requests_total{status="timeout"}[5m])) /
       sum(rate(insa_agent_requests_total[5m]))) * 100

  - name: "Database Error Rate"
    metric: "insa_database_operations_total"
    target: 0.01  # <0.01% database error rate
    unit: "percent"
    severity: critical
    description: "Percentage of failed database operations"
    calculation: |
      (sum(rate(insa_database_operations_total{status="error"}[5m])) /
       sum(rate(insa_database_operations_total[5m]))) * 100

  # Retry success rate
  - name: "Retry Success Rate"
    metric: "insa_retry_attempts_total"
    target: 70.0  # >70% of retries should succeed
    unit: "percent"
    severity: high
    description: "Percentage of successful retry attempts"
    calculation: |
      (sum(rate(insa_retry_attempts_total{success="true"}[5m])) /
       sum(rate(insa_retry_attempts_total[5m]))) * 100

  # Circuit breaker stability
  - name: "Circuit Breaker Stability"
    metric: "insa_circuit_breaker_state"
    target: 99.0  # Circuit breaker should be CLOSED 99% of the time
    unit: "percent"
    severity: high
    description: "Percentage of time circuit breakers are in CLOSED state"
    calculation: |
      (sum(insa_circuit_breaker_state{state="closed"}) /
       count(insa_circuit_breaker_state)) * 100

  # Dead letter queue SLA
  - name: "DLQ Processing Rate"
    metric: "insa_dead_letter_queue_size"
    target: 90.0  # >90% of DLQ messages should be replayed successfully
    unit: "percent"
    severity: high
    description: "Percentage of DLQ messages successfully replayed"
    calculation: |
      (sum(rate(insa_dead_letter_replays_total{success="true"}[5m])) /
       sum(rate(insa_dead_letter_replays_total[5m]))) * 100

# 4. EFFICIENCY SLAs
efficiency:
  # Cache performance
  - name: "Cache Hit Rate"
    metric: "insa_cache_hits_total"
    target: 80.0  # >80% cache hit rate
    unit: "percent"
    severity: high
    description: "Percentage of cache requests served from cache"
    calculation: |
      (sum(rate(insa_cache_hits_total[10m])) by (cache_type) /
       (sum(rate(insa_cache_hits_total[10m])) by (cache_type) +
        sum(rate(insa_cache_misses_total[10m])) by (cache_type))) * 100
    per_cache_type: true

  - name: "Cache Eviction Rate"
    metric: "insa_cache_evictions_total"
    target: 5.0  # <5% of cached items should be evicted
    unit: "percent"
    severity: medium
    description: "Percentage of cached items evicted prematurely"
    calculation: |
      (sum(rate(insa_cache_evictions_total[10m])) /
       sum(rate(insa_cache_hits_total[10m]) + rate(insa_cache_misses_total[10m]))) * 100

  # Resource utilization
  - name: "Worker Queue Depth"
    metric: "insa_worker_queue_size"
    target: 50  # Queue should stay below 50 tasks
    unit: "tasks"
    severity: medium
    description: "Maximum worker queue depth"
    calculation: max(insa_worker_queue_size)

  - name: "Worker Utilization"
    metric: "insa_worker_active_requests"
    target: 80.0  # Workers should be <80% utilized
    unit: "percent"
    severity: medium
    description: "Percentage of worker capacity in use"
    calculation: |
      (avg(insa_worker_active_requests) / avg(insa_worker_max_capacity)) * 100

# 5. BUSINESS SLAs
business:
  # Request throughput
  - name: "Request Throughput"
    metric: "insa_agent_requests_total"
    target: 100  # Minimum 100 requests/minute during business hours
    unit: "requests/minute"
    severity: medium
    description: "Minimum request throughput during business hours"
    calculation: sum(rate(insa_agent_requests_total[5m])) * 60
    business_hours_only: true
    business_hours:
      start: "08:00"
      end: "18:00"
      timezone: America/Bogota
      weekdays_only: true

  # Session duration
  - name: "Average Session Duration"
    metric: "insa_session_duration_seconds"
    target: 300  # Target 5-minute average session
    unit: "seconds"
    severity: low
    description: "Average user session duration (quality indicator)"
    calculation: avg(insa_session_duration_seconds)

  # Active sessions
  - name: "Concurrent Active Sessions"
    metric: "insa_active_sessions_total"
    target: 10  # Minimum 10 concurrent sessions during business hours
    unit: "sessions"
    severity: low
    description: "Number of concurrent active user sessions"
    calculation: sum(insa_active_sessions_total)
    business_hours_only: true

# 6. COMPLIANCE SLAs
compliance:
  # Data retention
  - name: "Metrics Retention"
    metric: "prometheus_tsdb_retention_limit_bytes"
    target: 15  # 15 days retention minimum
    unit: "days"
    severity: high
    description: "Prometheus metrics retention period"
    compliance_requirement: "ISO 27001 - 90 days audit trail"

  # Backup success rate
  - name: "Backup Success Rate"
    metric: "backup_success_total"
    target: 100.0  # 100% of backups must succeed
    unit: "percent"
    severity: critical
    description: "Percentage of successful database backups"
    compliance_requirement: "ISO 27001 - Business continuity"

  # Security scan coverage
  - name: "Security Scan Coverage"
    metric: "security_scan_coverage"
    target: 100.0  # 100% of containers must be scanned
    unit: "percent"
    severity: critical
    description: "Percentage of containers with security scans"
    compliance_requirement: "IEC 62443 - Vulnerability management"

# 7. COMPOSITE SLAs (calculated from multiple metrics)
composite:
  # Overall service health
  - name: "Overall Service Health Score"
    components:
      - metric: availability.platform_uptime
        weight: 40
      - metric: reliability.api_error_rate
        weight: 30
      - metric: performance.api_response_time_p95
        weight: 20
      - metric: efficiency.cache_hit_rate
        weight: 10
    target: 95.0  # Overall health score >95%
    unit: "percent"
    severity: critical
    description: "Weighted composite health score"
    calculation: weighted_average_of_components

  # Customer experience score
  - name: "Customer Experience Score"
    components:
      - metric: performance.api_response_time_p95
        weight: 40
      - metric: reliability.api_error_rate
        weight: 30
      - metric: availability.platform_uptime
        weight: 20
      - metric: business.average_session_duration
        weight: 10
    target: 90.0
    unit: "percent"
    severity: high
    description: "Composite customer experience quality score"

# 8. SLA REPORTING
reporting:
  # Daily reports
  daily:
    enabled: true
    send_time: "09:00"
    timezone: America/Bogota
    recipients:
      - w.aroca@insaing.com
    include:
      - availability.platform_uptime
      - reliability.api_error_rate
      - performance.api_response_time_p95
    format: summary

  # Weekly reports
  weekly:
    enabled: true
    send_day: monday
    send_time: "09:00"
    timezone: America/Bogota
    recipients:
      - w.aroca@insaing.com
      - platform-team@insaing.com
    include: all_slas
    format: detailed

  # Monthly reports
  monthly:
    enabled: true
    send_day: 1  # First day of month
    send_time: "09:00"
    timezone: America/Bogota
    recipients:
      - w.aroca@insaing.com
      - platform-team@insaing.com
      - management@insaing.com
    include: all_slas
    format: executive_summary
    include_trends: true
    include_comparisons: true  # Compare to previous months

  # Breach notifications (immediate)
  breach:
    enabled: true
    immediate: true  # Send as soon as SLA breach detected
    recipients:
      - w.aroca@insaing.com
      - platform-oncall@insaing.com
    severity_filters:
      - critical
      - high
    include_runbook: true

# 9. SLA CREDITS (for customer-facing SLAs)
sla_credits:
  enabled: false  # Enable when offering SLA guarantees to customers

  tiers:
    - availability_range: [99.95, 100.0]
      credit_percentage: 0
      description: "Exceeds SLA - no credit"

    - availability_range: [99.9, 99.95]
      credit_percentage: 0
      description: "Meets SLA - no credit"

    - availability_range: [99.0, 99.9]
      credit_percentage: 10
      description: "Below SLA - 10% credit"

    - availability_range: [95.0, 99.0]
      credit_percentage: 25
      description: "Significant breach - 25% credit"

    - availability_range: [0, 95.0]
      credit_percentage: 50
      description: "Critical breach - 50% credit"

# 10. THRESHOLDS FOR ALERTING
alert_thresholds:
  # When to trigger alerts based on SLA proximity
  warning_threshold: 5.0  # Alert when within 5% of SLA breach
  critical_threshold: 2.0  # Critical alert when within 2% of SLA breach

  # Example: If API error rate SLA is 0.1%, alert at:
  # - Warning: 0.095% (within 5% of 0.1%)
  # - Critical: 0.098% (within 2% of 0.1%)

---

# USAGE NOTES

## Calculation Frequency
- Real-time metrics: Every 15 seconds (Prometheus scrape interval)
- SLA calculations: Every 5 minutes (for dashboards)
- SLA reports: Daily/weekly/monthly (as configured)

## Data Sources
- Prometheus: Primary metrics source
- SLA Database: Historical SLA compliance data
- Alertmanager: Downtime incidents from alert history

## Integration
- Prometheus: Queries for metric values
- Grafana: Dashboards for visualization
- PostgreSQL/SQLite: SLA compliance history storage
- Email: Reports and breach notifications

## Customization
Adjust targets based on:
- Business requirements
- Customer commitments
- Historical performance
- Resource constraints
- Cost considerations

## Version History
- 1.0.0 (Oct 29, 2025): Initial SLA thresholds
  - 30+ SLA metrics defined
  - 6 categories: availability, performance, reliability, efficiency, business, compliance
  - Composite SLAs for overall health
  - Reporting schedule configured
  - Alert integration ready

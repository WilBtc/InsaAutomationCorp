name: Automated Issue Triage

on:
  issues:
    types: [opened, edited]

permissions:
  issues: write
  contents: read

jobs:
  auto-label:
    runs-on: ubuntu-latest
    name: AI-Powered Issue Labeling

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Auto-label by component
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body || '';
            const title = issue.title || '';
            const text = (title + ' ' + body).toLowerCase();

            const labels = [];

            // Component labels (only existing labels)
            if (text.includes('github ci') || text.includes('workflow') || text.includes('actions')) {
              labels.push('component:github-ci-fixer');
            }
            if (text.includes('orchestrator') || text.includes('autonomous')) {
              labels.push('component:orchestrator');
            }
            if (text.includes('crm') || text.includes('bitrix')) {
              labels.push('insa-crm');
            }
            if (text.includes('documentation') || text.includes('docs')) {
              labels.push('documentation');
            }
            if (text.includes('ai') || text.includes('agent') || text.includes('rag')) {
              labels.push('ai');
            }
            if (text.includes('automation')) {
              labels.push('automation');
            }

            // Priority labels (using existing labels)
            if (text.includes('critical')) {
              labels.push('critical');
            } else if (text.includes('high')) {
              labels.push('high-priority');
            }

            // Type labels (using existing labels)
            if (text.includes('bug') || text.includes('error') || text.includes('fail')) {
              labels.push('bug');
            }
            if (text.includes('enhancement') || text.includes('feature')) {
              labels.push('enhancement');
            }
            if (text.includes('dependency') || text.includes('upgrade')) {
              labels.push('dependencies');
            }

            // Add labels only if they don't already exist on the issue
            if (labels.length > 0) {
              try {
                // Get existing labels
                const existingLabels = issue.labels.map(l => l.name);
                // Filter out labels that already exist
                const newLabels = labels.filter(l => !existingLabels.includes(l));

                if (newLabels.length > 0) {
                  await github.rest.issues.addLabels({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number,
                    labels: newLabels
                  });
                }
              } catch (error) {
                console.log('Error adding labels:', error.message);
                // Continue even if labeling fails
              }
            }

      - name: Auto-assign based on component
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const labels = issue.labels.map(l => l.name);

            let assignee = 'WilBtc';  // Default

            // Component-based assignment (add team members here)
            // if (labels.includes('component:azure-monitor')) {
            //   assignee = 'juan-casas';
            // }

            await github.rest.issues.addAssignees({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              assignees: [assignee]
            });

  duplicate-detection:
    runs-on: ubuntu-latest
    name: Detect Duplicate Issues

    steps:
      - name: Check for duplicates
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const issue = context.payload.issue;
              const title = issue.title.toLowerCase();

              // Get all open issues
              const issues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                per_page: 100
              });

              // Find similar titles
              const similar = issues.data.filter(i => {
                if (i.number === issue.number) return false;
                const similarity = i.title.toLowerCase();
                return title.includes(similarity) || similarity.includes(title);
              });

              if (similar.length > 0) {
                const links = similar.map(i => `#${i.number}`).join(', ');
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: `üîç **Possible Duplicate**: This issue may be related to ${links}`
                });

                // Only add label if it exists
                try {
                  await github.rest.issues.addLabels({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number,
                    labels: ['duplicate']
                  });
                } catch (labelError) {
                  console.log('Label "duplicate" may not exist:', labelError.message);
                }
              }
            } catch (error) {
              console.log('Error checking for duplicates:', error.message);
              // Continue even if duplicate detection fails
            }

name: Code Quality

on:
  pull_request:
    paths:
      - '**.py'
      - 'pyproject.toml'
      - '.github/workflows/code-quality.yml'
  push:
    branches:
      - main
      - develop
    paths:
      - '**.py'
      - 'pyproject.toml'

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  quality:
    runs-on: ubuntu-latest
    name: Code Quality Checks

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff pylint black isort mypy pytest pytest-cov radon

      - name: Run Ruff (Fast Linting)
        id: ruff
        continue-on-error: true
        run: |
          echo "## Ruff Linting Results" >> $GITHUB_STEP_SUMMARY
          ruff check . --output-format=github >> $GITHUB_STEP_SUMMARY || true
          ruff check . --exit-zero

      - name: Run Pylint (Deep Analysis)
        id: pylint
        continue-on-error: true
        run: |
          echo "## Pylint Analysis Results" >> $GITHUB_STEP_SUMMARY
          pylint automation/ --exit-zero --output-format=text 2>&1 | head -100 >> $GITHUB_STEP_SUMMARY || true

      - name: Check Black Formatting
        id: black
        continue-on-error: true
        run: |
          echo "## Black Formatting Check" >> $GITHUB_STEP_SUMMARY
          black --check --diff . 2>&1 | head -50 >> $GITHUB_STEP_SUMMARY || true

      - name: Check Import Sorting (isort)
        id: isort
        continue-on-error: true
        run: |
          echo "## Import Sorting Check" >> $GITHUB_STEP_SUMMARY
          isort --check-only --diff . 2>&1 | head -50 >> $GITHUB_STEP_SUMMARY || true

      - name: Run Type Checking (mypy)
        id: mypy
        continue-on-error: true
        run: |
          echo "## Type Checking Results (mypy)" >> $GITHUB_STEP_SUMMARY
          mypy automation/ --ignore-missing-imports --no-error-summary 2>&1 | tail -20 >> $GITHUB_STEP_SUMMARY || true

      - name: Run Complexity Analysis (radon)
        id: radon
        continue-on-error: true
        run: |
          echo "## Code Complexity Analysis" >> $GITHUB_STEP_SUMMARY
          echo "### Cyclomatic Complexity (lower is better)" >> $GITHUB_STEP_SUMMARY
          radon cc automation/ -a -nb >> $GITHUB_STEP_SUMMARY || true
          echo "### Maintainability Index (higher is better)" >> $GITHUB_STEP_SUMMARY
          radon mi automation/ -nb >> $GITHUB_STEP_SUMMARY || true

      - name: Run Tests with Coverage
        id: pytest
        continue-on-error: true
        run: |
          pytest tests/ --cov=automation --cov-report=term --cov-report=xml --cov-report=html -v || true

      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
          verbose: true

      - name: Generate Coverage Report Summary
        if: always()
        continue-on-error: true
        run: |
          echo "## Coverage Report" >> $GITHUB_STEP_SUMMARY
          if [ -f coverage.xml ]; then
            echo "Coverage data available (see artifact)" >> $GITHUB_STEP_SUMMARY
          else
            echo "No coverage data generated" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload HTML Coverage Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: htmlcov/
          retention-days: 30

      - name: Comment PR with Quality Summary
        if: github.event_name == 'pull_request'
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = `## Code Quality Check Results

            ### Quality Tools Status
            - ✅ Ruff: Fast linting complete
            - ✅ Pylint: Deep analysis complete
            - ✅ Black: Format checking complete
            - ✅ isort: Import sorting check complete
            - ✅ mypy: Type checking complete
            - ✅ Radon: Complexity analysis complete
            - ✅ pytest: Test coverage analyzed

            See [workflow logs](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details.

            **Coverage Report**: See attached artifact for full HTML report.`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });

  security-check:
    runs-on: ubuntu-latest
    name: Security & Bandit Check

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Bandit
        run: pip install bandit

      - name: Run Bandit Security Check
        id: bandit
        continue-on-error: true
        run: |
          echo "## Bandit Security Analysis" >> $GITHUB_STEP_SUMMARY
          bandit -r automation/ -f json -o bandit-report.json || true
          bandit -r automation/ -f txt 2>&1 | head -50 >> $GITHUB_STEP_SUMMARY || true

      - name: Upload Bandit Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bandit-security-report
          path: bandit-report.json
          retention-days: 30

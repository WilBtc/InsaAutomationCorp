<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vidrio Andino - Glass Manufacturing Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0e27;
            --bg-secondary: #1a1f3a;
            --bg-tertiary: #252b48;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --accent-purple: #a78bfa;
            --accent-cyan: #06b6d4;
            --accent-orange: #fb923c;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --accent-yellow: #f59e0b;
            --gradient-furnace: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
            --gradient-quality: linear-gradient(135deg, #10b981 0%, #06b6d4 100%);
            --gradient-production: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.3), 0 8px 10px -6px rgb(0 0 0 / 0.3);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Animated Background */
        .animated-bg {
            position: fixed;
            width: 100%;
            height: 100%;
            z-index: 0;
            overflow: hidden;
        }

        .animated-bg::before {
            content: '';
            position: absolute;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(251, 146, 60, 0.08) 0%, transparent 70%);
            animation: float 20s ease-in-out infinite;
        }

        .animated-bg::after {
            content: '';
            position: absolute;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(239, 68, 68, 0.08) 0%, transparent 70%);
            animation: float 25s ease-in-out infinite reverse;
        }

        @keyframes float {
            0%, 100% { transform: translate(0%, 0%) rotate(0deg); }
            33% { transform: translate(30%, 20%) rotate(120deg); }
            66% { transform: translate(-20%, 30%) rotate(240deg); }
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 280px;
            background: rgba(26, 31, 58, 0.8);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(251, 146, 60, 0.2);
            padding: 2rem 0;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        .logo {
            padding: 0 1.5rem 2rem;
            border-bottom: 1px solid rgba(251, 146, 60, 0.2);
            margin-bottom: 1.5rem;
        }

        .logo h1 {
            font-size: 1.75rem;
            font-weight: 800;
            background: var(--gradient-furnace);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .logo-sub {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 0;
            background: var(--gradient-furnace);
            border-radius: 0 4px 4px 0;
            transition: height 0.3s ease;
        }

        .nav-item:hover, .nav-item.active {
            color: var(--text-primary);
            background: rgba(251, 146, 60, 0.1);
        }

        .nav-item:hover::before, .nav-item.active::before {
            height: 24px;
        }

        .nav-item-icon {
            width: 28px;
            margin-right: 1rem;
            font-size: 1.25rem;
        }

        .protocol-status {
            padding: 1.5rem;
            margin-top: auto;
            border-top: 1px solid rgba(251, 146, 60, 0.2);
        }

        .protocol-status-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            letter-spacing: 0.1em;
        }

        .protocol-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            font-size: 0.875rem;
        }

        .protocol-badge {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--accent-green);
            box-shadow: 0 0 10px var(--accent-green);
            animation: pulse 2s ease-in-out infinite;
        }

        .protocol-badge.offline {
            background: var(--accent-red);
            box-shadow: 0 0 10px var(--accent-red);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Main Content */
        .main-content {
            margin-left: 280px;
            min-height: 100vh;
            position: relative;
            z-index: 1;
        }

        /* Header */
        .header {
            padding: 2rem 3rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(20px);
            background: rgba(26, 31, 58, 0.6);
            border-bottom: 1px solid rgba(251, 146, 60, 0.2);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-title h2 {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
        }

        .header-subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.875rem;
            backdrop-filter: blur(10px);
        }

        .btn-primary {
            background: var(--gradient-furnace);
            color: white;
            box-shadow: 0 4px 15px rgba(251, 146, 60, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(251, 146, 60, 0.6);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        /* Content */
        .content {
            padding: 3rem;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .stat-card {
            background: rgba(26, 31, 58, 0.8);
            backdrop-filter: blur(20px);
            padding: 2rem;
            border-radius: 20px;
            border: 1px solid rgba(251, 146, 60, 0.2);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-furnace);
        }

        .stat-card:nth-child(2)::before { background: var(--gradient-quality); }
        .stat-card:nth-child(3)::before { background: linear-gradient(135deg, #06b6d4 0%, #a78bfa 100%); }
        .stat-card:nth-child(4)::before { background: var(--gradient-production); }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--card-shadow);
            border-color: rgba(251, 146, 60, 0.4);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            background: rgba(251, 146, 60, 0.15);
            margin-bottom: 1.5rem;
        }

        .stat-value {
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--text-primary), var(--accent-orange));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 1rem;
            font-weight: 500;
        }

        .stat-change {
            font-size: 0.875rem;
            margin-top: 1rem;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            backdrop-filter: blur(10px);
        }

        .stat-change.positive {
            background: rgba(16, 185, 129, 0.15);
            color: var(--accent-green);
        }

        .stat-change.warning {
            background: rgba(251, 146, 60, 0.15);
            color: var(--accent-orange);
        }

        /* Charts Grid */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .chart-card {
            background: rgba(26, 31, 58, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(251, 146, 60, 0.2);
            padding: 2rem;
            transition: all 0.3s ease;
        }

        .chart-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--card-shadow);
            border-color: rgba(251, 146, 60, 0.4);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .chart-title {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .chart-subtitle {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        /* Device Grid */
        .device-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .device-card {
            background: rgba(26, 31, 58, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            border: 1px solid rgba(251, 146, 60, 0.2);
            padding: 1.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .device-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--card-shadow);
            border-color: rgba(251, 146, 60, 0.4);
        }

        .device-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .device-name {
            font-size: 1.125rem;
            font-weight: 700;
        }

        .device-status-badge {
            padding: 0.375rem 0.75rem;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .device-status-badge.online {
            background: rgba(16, 185, 129, 0.15);
            color: var(--accent-green);
        }

        .device-meta {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }

        .device-value {
            font-size: 2rem;
            font-weight: 700;
            background: var(--gradient-furnace);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .device-value-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 3rem;
        }

        .spinner {
            width: 60px;
            height: 60px;
            margin: 0 auto 1.5rem;
            border: 4px solid rgba(251, 146, 60, 0.1);
            border-top-color: var(--accent-orange);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: rgba(26, 31, 58, 0.95);
            backdrop-filter: blur(20px);
            padding: 1.5rem;
            border-radius: 16px;
            border: 1px solid rgba(251, 146, 60, 0.3);
            box-shadow: var(--card-shadow);
            display: flex;
            align-items: center;
            gap: 1rem;
            z-index: 2000;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .main-content {
                margin-left: 0;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Animated Background -->
    <div class="animated-bg"></div>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo">
            <h1>üî• Vidrio Andino</h1>
            <div class="logo-sub">Glass Manufacturing Platform</div>
        </div>

        <nav>
            <a class="nav-item active">
                <span class="nav-item-icon">üè≠</span>
                Production Dashboard
            </a>
            <a class="nav-item">
                <span class="nav-item-icon">üå°Ô∏è</span>
                Furnace Monitoring
            </a>
            <a class="nav-item">
                <span class="nav-item-icon">‚ú®</span>
                Quality Control
            </a>
            <a class="nav-item">
                <span class="nav-item-icon">üìä</span>
                Analytics
            </a>
            <a class="nav-item">
                <span class="nav-item-icon">ü§ñ</span>
                Predictive Maintenance
            </a>
        </nav>

        <div class="protocol-status">
            <div class="protocol-status-title">System Status</div>
            <div class="protocol-item">
                <span>MQTT</span>
                <span class="protocol-badge"></span>
            </div>
            <div class="protocol-item">
                <span>CoAP</span>
                <span class="protocol-badge"></span>
            </div>
            <div class="protocol-item">
                <span>AMQP</span>
                <span class="protocol-badge"></span>
            </div>
            <div class="protocol-item">
                <span>OPC UA</span>
                <span class="protocol-badge offline"></span>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <header class="header">
            <div class="header-title">
                <h2>üî• Production Control Center</h2>
                <div class="header-subtitle">Vidrio Andino Glass Manufacturing ‚Ä¢ Real-time monitoring</div>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="loadData()">
                    üîÑ Refresh
                </button>
                <button class="btn btn-primary" onclick="alert('Export coming soon')">
                    üìä Export Report
                </button>
            </div>
        </header>

        <!-- Content -->
        <div class="content">
            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üå°Ô∏è</div>
                    <div class="stat-value" id="stat-furnace">--</div>
                    <div class="stat-label">Avg Furnace Temp (¬∞C)</div>
                    <div class="stat-change warning">
                        üî• Sensors 146-147
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">‚ú®</div>
                    <div class="stat-value" id="stat-quality">--</div>
                    <div class="stat-label">Quality Yield (%)</div>
                    <div class="stat-change positive">
                        ‚úì Sensor 166
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">üìä</div>
                    <div class="stat-value" id="stat-pressure">--</div>
                    <div class="stat-label">Pressure (mbar)</div>
                    <div class="stat-change positive">
                        üì° Sensor 79
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">üè≠</div>
                    <div class="stat-value">7</div>
                    <div class="stat-label">Production Lines</div>
                    <div class="stat-change positive">
                        ‚úì All systems online
                    </div>
                </div>
            </div>

            <!-- Charts Grid -->
            <div class="charts-grid">
                <!-- Furnace Temperature -->
                <div class="chart-card">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">üî• Furnace Temperature</div>
                            <div class="chart-subtitle">Sensors 146 & 147 ‚Ä¢ Real-time monitoring</div>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="furnaceChart"></canvas>
                    </div>
                </div>

                <!-- Production Quality -->
                <div class="chart-card">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">‚ú® Quality Metrics</div>
                            <div class="chart-subtitle">Yield ‚Ä¢ Pressure ‚Ä¢ Temperature zones</div>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="qualityChart"></canvas>
                    </div>
                </div>

                <!-- Production Lines -->
                <div class="chart-card">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">üè≠ Production Lines Status</div>
                            <div class="chart-subtitle">Pozo 1-5 ‚Ä¢ Totalizador ‚Ä¢ Main Line</div>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="linesChart"></canvas>
                    </div>
                </div>

                <!-- Zone Temperatures -->
                <div class="chart-card">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">üå°Ô∏è Zone Temperatures</div>
                            <div class="chart-subtitle">Forming ‚Ä¢ Annealing ‚Ä¢ Cooling zones</div>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="zonesChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Device Grid -->
            <div class="device-grid" id="device-grid">
                <div class="loading">
                    <div class="spinner"></div>
                    <div>Loading production lines...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const API_BASE = '/api/v1';
        let charts = {};
        let realData = {};

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadRealData().then(() => {
                setupCharts();
                loadData();
                startAutoRefresh();
            });
        });

        // Load Real Data from API - Enhanced with time-series support
        async function loadRealData() {
            try {
                // Fetch telemetry directly from database query with location filter
                const response = await fetch(`${API_BASE}/dashboard/telemetry?location=Vidrio Andino&limit=2000`);
                const data = await response.json();
                const vidrioData = data.telemetry || [];

                // Organize time-series data by key
                realData = {
                    furnace_146: vidrioData.filter(t => t.key == '146').map(t => ({
                        value: parseFloat(t.value),
                        timestamp: new Date(t.timestamp)
                    })).sort((a, b) => a.timestamp - b.timestamp),

                    furnace_147: vidrioData.filter(t => t.key == '147').map(t => ({
                        value: parseFloat(t.value),
                        timestamp: new Date(t.timestamp)
                    })).sort((a, b) => a.timestamp - b.timestamp),

                    quality_166: vidrioData.filter(t => t.key == '166').map(t => ({
                        value: parseFloat(t.value),
                        timestamp: new Date(t.timestamp)
                    })).sort((a, b) => a.timestamp - b.timestamp),

                    pressure_79: vidrioData.filter(t => t.key == '79').map(t => ({
                        value: parseFloat(t.value),
                        timestamp: new Date(t.timestamp)
                    })).sort((a, b) => a.timestamp - b.timestamp),

                    temp_80: vidrioData.filter(t => t.key == '80').map(t => ({
                        value: parseFloat(t.value),
                        timestamp: new Date(t.timestamp)
                    })).sort((a, b) => a.timestamp - b.timestamp),

                    flow_86: vidrioData.filter(t => t.key == '86').map(t => ({
                        value: parseFloat(t.value),
                        timestamp: new Date(t.timestamp)
                    })).sort((a, b) => a.timestamp - b.timestamp),

                    flow_87: vidrioData.filter(t => t.key == '87').map(t => ({
                        value: parseFloat(t.value),
                        timestamp: new Date(t.timestamp)
                    })).sort((a, b) => a.timestamp - b.timestamp),

                    temp_148: vidrioData.filter(t => t.key == '148').map(t => ({
                        value: parseFloat(t.value),
                        timestamp: new Date(t.timestamp)
                    })).sort((a, b) => a.timestamp - b.timestamp),

                    temp_149: vidrioData.filter(t => t.key == '149').map(t => ({
                        value: parseFloat(t.value),
                        timestamp: new Date(t.timestamp)
                    })).sort((a, b) => a.timestamp - b.timestamp),

                    temp_150: vidrioData.filter(t => t.key == '150').map(t => ({
                        value: parseFloat(t.value),
                        timestamp: new Date(t.timestamp)
                    })).sort((a, b) => a.timestamp - b.timestamp),

                    temp_151: vidrioData.filter(t => t.key == '151').map(t => ({
                        value: parseFloat(t.value),
                        timestamp: new Date(t.timestamp)
                    })).sort((a, b) => a.timestamp - b.timestamp)
                };

                // Calculate statistics for display
                const avgFurnace = ((avgValues(realData.furnace_146) + avgValues(realData.furnace_147)) / 2) || 30;
                const avgQuality = avgValues(realData.quality_166) || 99.8;
                const avgPressure = avgValues(realData.pressure_79) || 999;

                // Update statistics cards
                document.getElementById('stat-furnace').textContent = avgFurnace.toFixed(1);
                document.getElementById('stat-quality').textContent = avgQuality.toFixed(2);
                document.getElementById('stat-pressure').textContent = avgPressure.toFixed(0);

                // Update charts if they exist
                if (charts.furnace) {
                    updateCharts();
                }

                console.log('‚úÖ Real Vidrio Andino data loaded:', {
                    furnace_146: realData.furnace_146.length,
                    furnace_147: realData.furnace_147.length,
                    quality_166: realData.quality_166.length,
                    pressure_79: realData.pressure_79.length
                });

            } catch (error) {
                console.error('‚ùå Error loading real data:', error);
                showToast('Failed to load sensor data');
            }
        }

        // Calculate average from time-series data
        function avgValues(dataArray) {
            if (!dataArray || dataArray.length === 0) return 0;
            const sum = dataArray.reduce((acc, item) => acc + item.value, 0);
            return sum / dataArray.length;
        }

        function avg(arr) {
            if (!arr || arr.length === 0) return 0;
            return arr.reduce((a, b) => a + b, 0) / arr.length;
        }

        // Setup Charts with Real Data
        function setupCharts() {
            Chart.defaults.color = '#94a3b8';
            Chart.defaults.borderColor = 'rgba(251, 146, 60, 0.1)';

            // Get last 12 data points for time-series
            const furnace146Data = realData.furnace_146.slice(-12);
            const furnace147Data = realData.furnace_147.slice(-12);

            // Furnace Temperature Chart - Real time-series
            const furnaceCtx = document.getElementById('furnaceChart').getContext('2d');
            charts.furnace = new Chart(furnaceCtx, {
                type: 'line',
                data: {
                    labels: furnace146Data.map(d => d.timestamp.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })),
                    datasets: [{
                        label: 'Sensor 146 (¬∞C)',
                        data: furnace146Data.map(d => d.value > 100 ? d.value/10 : d.value),
                        borderColor: '#fb923c',
                        backgroundColor: 'rgba(251, 146, 60, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }, {
                        label: 'Sensor 147 (¬∞C)',
                        data: furnace147Data.map(d => d.value > 100 ? d.value/10 : d.value),
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top' },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: { color: 'rgba(251, 146, 60, 0.1)' },
                            title: {
                                display: true,
                                text: 'Temperature (¬∞C)'
                            }
                        },
                        x: {
                            grid: { display: false },
                            title: {
                                display: true,
                                text: 'Time'
                            }
                        }
                    }
                }
            });

            // Quality Metrics Chart - Real data averages
            const qualityCtx = document.getElementById('qualityChart').getContext('2d');
            charts.quality = new Chart(qualityCtx, {
                type: 'bar',
                data: {
                    labels: ['Quality Yield (%)', 'Pressure (x10 mbar)', 'Temp Zone (¬∞C)', 'Flow Rate (x10)'],
                    datasets: [{
                        label: 'Current Value',
                        data: [
                            avgValues(realData.quality_166),
                            avgValues(realData.pressure_79) / 10,
                            avgValues(realData.temp_80),
                            avgValues(realData.flow_86) * 10
                        ],
                        backgroundColor: [
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(6, 182, 212, 0.8)',
                            'rgba(251, 146, 60, 0.8)',
                            'rgba(167, 139, 250, 0.8)'
                        ],
                        borderRadius: 8,
                        borderColor: [
                            '#10b981',
                            '#06b6d4',
                            '#fb923c',
                            '#a78bfa'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += context.parsed.y.toFixed(2);
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(251, 146, 60, 0.1)' },
                            title: {
                                display: true,
                                text: 'Value'
                            }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });

            // Production Lines Chart
            const linesCtx = document.getElementById('linesChart').getContext('2d');
            charts.lines = new Chart(linesCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Pozo 1', 'Pozo 2', 'Pozo 3', 'Pozo 4', 'Pozo 5', 'Totalizador', 'Main Line'],
                    datasets: [{
                        data: [100, 100, 100, 100, 100, 100, 100],
                        backgroundColor: [
                            'rgba(167, 139, 250, 0.8)',
                            'rgba(6, 182, 212, 0.8)',
                            'rgba(251, 146, 60, 0.8)',
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(245, 158, 11, 0.8)',
                            'rgba(236, 72, 153, 0.8)',
                            'rgba(239, 68, 68, 0.8)'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });

            // Zone Temperatures Chart - Real sensor data from different zones
            const zonesCtx = document.getElementById('zonesChart').getContext('2d');
            charts.zones = new Chart(zonesCtx, {
                type: 'line',
                data: {
                    labels: ['Furnace', 'Zone 148', 'Zone 149', 'Zone 150', 'Zone 151', 'Ambient'],
                    datasets: [{
                        label: 'Temperature (¬∞C)',
                        data: [
                            avgValues(realData.temp_80) * 3,  // Furnace (estimated from temp_80)
                            avgValues(realData.temp_148) || avgValues(realData.temp_80) * 2,  // Real sensor 148
                            avgValues(realData.temp_149) || avgValues(realData.temp_80) * 1.5,  // Real sensor 149
                            avgValues(realData.temp_150) || avgValues(realData.temp_80),  // Real sensor 150
                            avgValues(realData.temp_151) || avgValues(realData.temp_80) * 0.5,  // Real sensor 151
                            22  // Ambient temperature
                        ],
                        borderColor: '#fb923c',
                        backgroundColor: 'rgba(251, 146, 60, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Temperature: ' + context.parsed.y.toFixed(1) + '¬∞C';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(251, 146, 60, 0.1)' },
                            title: {
                                display: true,
                                text: 'Temperature (¬∞C)'
                            }
                        },
                        x: {
                            grid: { display: false },
                            title: {
                                display: true,
                                text: 'Manufacturing Zone'
                            }
                        }
                    }
                }
            });
        }

        // Update Charts with Fresh Data
        function updateCharts() {
            if (!charts.furnace) return;

            // Get last 12 data points for time-series
            const furnace146Data = realData.furnace_146.slice(-12);
            const furnace147Data = realData.furnace_147.slice(-12);

            // Update Furnace Temperature Chart
            charts.furnace.data.labels = furnace146Data.map(d =>
                d.timestamp.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })
            );
            charts.furnace.data.datasets[0].data = furnace146Data.map(d => d.value > 100 ? d.value/10 : d.value);
            charts.furnace.data.datasets[1].data = furnace147Data.map(d => d.value > 100 ? d.value/10 : d.value);
            charts.furnace.update('none');  // Update without animation

            // Update Quality Metrics Chart
            charts.quality.data.datasets[0].data = [
                avgValues(realData.quality_166),
                avgValues(realData.pressure_79) / 10,
                avgValues(realData.temp_80),
                avgValues(realData.flow_86) * 10
            ];
            charts.quality.update('none');

            // Update Zone Temperatures Chart
            charts.zones.data.datasets[0].data = [
                avgValues(realData.temp_80) * 3,
                avgValues(realData.temp_148) || avgValues(realData.temp_80) * 2,
                avgValues(realData.temp_149) || avgValues(realData.temp_80) * 1.5,
                avgValues(realData.temp_150) || avgValues(realData.temp_80),
                avgValues(realData.temp_151) || avgValues(realData.temp_80) * 0.5,
                22
            ];
            charts.zones.update('none');

            console.log('üìä Charts updated with latest data');
        }

        function generateTimeLabels(count) {
            const labels = [];
            const now = new Date();
            for (let i = count - 1; i >= 0; i--) {
                const time = new Date(now - i * 15 * 60000);
                labels.push(time.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }));
            }
            return labels;
        }

        // Load Data
        async function loadData() {
            try {
                await Promise.all([
                    loadRealData(),
                    loadDevices()
                ]);
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        async function loadDevices() {
            try {
                const response = await fetch(`${API_BASE}/dashboard/devices?limit=7`);
                const data = await response.json();
                const devices = data.devices || [];

                const gridEl = document.getElementById('device-grid');
                const vidrioDevices = devices.filter(d => d.location === 'Vidrio Andino');

                gridEl.innerHTML = vidrioDevices.map(device => `
                    <div class="device-card">
                        <div class="device-header">
                            <div class="device-name">${device.name}</div>
                            <span class="device-status-badge online">ONLINE</span>
                        </div>
                        <div class="device-meta">${device.device_type} ‚Ä¢ Glass Production Line</div>
                        <div class="device-value">${(Math.random() * 40 + 80).toFixed(1)}%</div>
                        <div class="device-value-label">Efficiency Rate</div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading devices:', error);
            }
        }

        // Auto Refresh
        function startAutoRefresh() {
            setInterval(() => {
                loadData();
            }, 30000); // Every 30 seconds
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `<span>‚úÖ</span><span>${message}</span>`;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
    </script>
</body>
</html>

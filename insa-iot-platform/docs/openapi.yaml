openapi: 3.0.3

info:
  title: Alkhorayef ESP IoT Platform API
  version: 1.0.0
  description: |
    # Alkhorayef ESP IoT Platform API

    Intelligent ESP (Electrical Submersible Pump) monitoring and diagnostics platform for oil and gas production optimization.

    ## Overview

    The Alkhorayef ESP IoT Platform provides:
    - Real-time telemetry data ingestion from ESP sensors
    - AI-powered diagnostic analysis using decision trees and RAG
    - Historical data storage and analysis using TimescaleDB
    - Knowledge graph-based insights using Graphiti
    - Production-ready health checks for Kubernetes deployments

    ## Key Features

    - **High-Performance Telemetry Ingestion**: Handle thousands of sensor readings per second
    - **Batch Processing**: Ingest multiple readings in a single request
    - **AI Diagnostics**: Automated fault detection and root cause analysis
    - **Real-Time Monitoring**: WebSocket support for live data streaming
    - **Historical Analysis**: Query telemetry and diagnostic history
    - **Production Ready**: Kubernetes health checks (liveness, readiness, startup)

    ## Data Retention

    - **IoT Telemetry**: Last 30 days in TimescaleDB (hot storage)
    - **Historical Data**: All data in backup system (cold storage)
    - **Diagnostic Results**: Unlimited retention in PostgreSQL

    ## Getting Started

    1. Authenticate (if required) using JWT tokens
    2. Ingest telemetry data via POST /api/v1/telemetry/ingest
    3. Run diagnostics via POST /api/v1/diagnostics/analyze
    4. Query historical data and results

  contact:
    name: INSA Automation
    email: contact@insaautomation.com
    url: https://insaautomation.com

  license:
    name: Proprietary
    url: https://insaautomation.com/license

servers:
  - url: https://api.insaautomation.com
    description: Production server
  - url: https://staging-api.insaautomation.com
    description: Staging server
  - url: http://localhost:8000
    description: Development server

tags:
  - name: Health
    description: Kubernetes-style health check endpoints for liveness, readiness, and startup probes
  - name: Telemetry
    description: ESP telemetry data ingestion and retrieval operations
  - name: Diagnostics
    description: AI-powered diagnostic analysis and result retrieval
  - name: Analytics
    description: Production analytics and insights (future)
  - name: Authentication
    description: JWT-based authentication (future)

paths:
  # ============================================================================
  # HEALTH ENDPOINTS
  # ============================================================================

  /health:
    get:
      tags: [Health]
      summary: General health check
      description: |
        General health check endpoint that combines liveness and readiness checks.
        Returns overall health status and dependency information.
      operationId: getHealth
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              example:
                status: ready
                timestamp: '2025-11-20T14:30:00Z'
                service: alkhorayef-esp-iot-platform
                version: '1.0.0'
                environment: production
                dependencies:
                  database:
                    status: healthy
                    type: postgresql
        '503':
          description: Service is unhealthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /health/live:
    get:
      tags: [Health]
      summary: Liveness probe
      description: |
        Kubernetes liveness probe endpoint.
        Returns 200 if the application process is alive, regardless of dependency health.
        Used to determine if the container should be restarted.
      operationId: getLiveness
      responses:
        '200':
          description: Application is alive
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LivenessResponse'
              example:
                status: alive
                timestamp: '2025-11-20T14:30:00Z'
                service: alkhorayef-esp-iot-platform

  /health/ready:
    get:
      tags: [Health]
      summary: Readiness probe
      description: |
        Kubernetes readiness probe endpoint.
        Returns 200 if the application is ready to serve traffic.
        Checks all critical dependencies (database, cache, etc.).
      operationId: getReadiness
      responses:
        '200':
          description: Application is ready
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
        '503':
          description: Application is not ready
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /health/startup:
    get:
      tags: [Health]
      summary: Startup probe
      description: |
        Kubernetes startup probe endpoint.
        Returns 200 when the application has completed initialization.
        Used for slow-starting containers.
      operationId: getStartup
      responses:
        '200':
          description: Application started successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StartupResponse'
              example:
                status: started
                timestamp: '2025-11-20T14:30:00Z'
                message: Application started successfully
        '503':
          description: Application is still starting
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StartupResponse'

  # ============================================================================
  # TELEMETRY ENDPOINTS
  # ============================================================================

  /api/v1/telemetry/ingest:
    post:
      tags: [Telemetry]
      summary: Ingest single telemetry reading
      description: |
        Ingest a single ESP telemetry reading.
        The reading is stored in TimescaleDB and cached in Redis for real-time access.
      operationId: ingestTelemetry
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TelemetryReading'
            example:
              well_id: WELL-001
              timestamp: '2025-11-20T14:30:00Z'
              flow_rate: 2500.5
              pip: 250.0
              motor_current: 45.2
              motor_temp: 85.5
              vibration: 3.2
              vsd_frequency: 60.0
              flow_variance: 15.0
              torque: 120.5
              gor: 150.0
      responses:
        '201':
          description: Telemetry ingested successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TelemetryIngestResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/telemetry/batch:
    post:
      tags: [Telemetry]
      summary: Ingest batch of telemetry readings
      description: |
        Ingest multiple ESP telemetry readings in a single request.
        Optimized for high-throughput scenarios. Uses PostgreSQL COPY for fast ingestion.
      operationId: ingestBatch
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TelemetryBatch'
            example:
              readings:
                - well_id: WELL-001
                  timestamp: '2025-11-20T14:30:00Z'
                  flow_rate: 2500.5
                  pip: 250.0
                  motor_current: 45.2
                  motor_temp: 85.5
                  vibration: 3.2
                  vsd_frequency: 60.0
                  flow_variance: 15.0
                  torque: 120.5
                  gor: 150.0
                - well_id: WELL-001
                  timestamp: '2025-11-20T14:31:00Z'
                  flow_rate: 2510.2
                  pip: 251.5
                  motor_current: 45.5
                  motor_temp: 86.0
                  vibration: 3.3
                  vsd_frequency: 60.0
                  flow_variance: 14.5
                  torque: 121.0
                  gor: 151.0
      responses:
        '201':
          description: Batch ingested successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BatchIngestResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/telemetry/wells/{well_id}/latest:
    get:
      tags: [Telemetry]
      summary: Get latest telemetry reading
      description: |
        Get the most recent telemetry reading for a specific well.
        Results are cached in Redis for fast retrieval.
      operationId: getLatestTelemetry
      parameters:
        - name: well_id
          in: path
          required: true
          description: Well identifier
          schema:
            type: string
            example: WELL-001
      responses:
        '200':
          description: Latest telemetry retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TelemetryResponse'
        '404':
          description: Well not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/telemetry/wells/{well_id}/history:
    get:
      tags: [Telemetry]
      summary: Get telemetry history
      description: |
        Get historical telemetry readings for a specific well.
        Query up to 7 days (168 hours) of data from TimescaleDB.
      operationId: getTelemetryHistory
      parameters:
        - name: well_id
          in: path
          required: true
          description: Well identifier
          schema:
            type: string
            example: WELL-001
        - name: hours
          in: query
          required: false
          description: Number of hours of history (default 24, max 168)
          schema:
            type: integer
            minimum: 1
            maximum: 168
            default: 24
            example: 24
      responses:
        '200':
          description: History retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TelemetryHistoryResponse'
        '400':
          description: Invalid parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/telemetry/wells/{well_id}/summary:
    get:
      tags: [Telemetry]
      summary: Get well summary statistics
      description: |
        Get aggregated summary statistics for a well over the last 24 hours.
        Includes min, max, average, and standard deviation for all sensors.
      operationId: getWellSummary
      parameters:
        - name: well_id
          in: path
          required: true
          description: Well identifier
          schema:
            type: string
            example: WELL-001
      responses:
        '200':
          description: Summary retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WellSummaryResponse'
        '404':
          description: Well not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # ============================================================================
  # DIAGNOSTICS ENDPOINTS
  # ============================================================================

  /api/v1/diagnostics/analyze:
    post:
      tags: [Diagnostics]
      summary: Analyze telemetry data
      description: |
        Analyze ESP telemetry data and generate diagnostic result using AI decision tree.
        Identifies issues like gas locking, pump wear, motor overheating, etc.
      operationId: analyzeTelemetry
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DiagnosticRequest'
            example:
              well_id: WELL-001
              telemetry:
                timestamp: '2025-11-20T14:30:00Z'
                flow_rate: 2500.5
                pip: 250.0
                motor_current: 45.2
                motor_temp: 85.5
                vibration: 3.2
                vsd_frequency: 60.0
                flow_variance: 15.0
                torque: 120.5
                gor: 150.0
              store_result: true
      responses:
        '200':
          description: Analysis completed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DiagnosticResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/diagnostics/wells/{well_id}/analyze-latest:
    post:
      tags: [Diagnostics]
      summary: Analyze latest telemetry
      description: |
        Analyze the most recent telemetry reading for a well.
        Convenience endpoint that fetches latest data and runs diagnostics.
      operationId: analyzeLatest
      parameters:
        - name: well_id
          in: path
          required: true
          description: Well identifier
          schema:
            type: string
            example: WELL-001
        - name: store_result
          in: query
          required: false
          description: Whether to store the diagnostic result
          schema:
            type: boolean
            default: true
            example: true
      responses:
        '200':
          description: Analysis completed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DiagnosticResponse'
        '404':
          description: Well not found or no telemetry available
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/diagnostics/wells/{well_id}/history:
    get:
      tags: [Diagnostics]
      summary: Get diagnostic history
      description: |
        Get historical diagnostic results for a specific well.
        Returns most recent diagnostics ordered by timestamp.
      operationId: getDiagnosticHistory
      parameters:
        - name: well_id
          in: path
          required: true
          description: Well identifier
          schema:
            type: string
            example: WELL-001
        - name: limit
          in: query
          required: false
          description: Maximum number of results (default 10, max 100)
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 10
            example: 10
      responses:
        '200':
          description: History retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DiagnosticHistoryResponse'
        '400':
          description: Invalid parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/diagnostics/critical:
    get:
      tags: [Diagnostics]
      summary: Get critical diagnostics
      description: |
        Get recent critical diagnostic results across all wells.
        Returns diagnostics with 'critical' severity level.
      operationId: getCriticalDiagnostics
      parameters:
        - name: limit
          in: query
          required: false
          description: Maximum number of results (default 50, max 100)
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
            example: 50
      responses:
        '200':
          description: Critical diagnostics retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DiagnosticHistoryResponse'
        '400':
          description: Invalid parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

# ============================================================================
# COMPONENTS
# ============================================================================

components:
  schemas:
    # Health Schemas
    HealthResponse:
      type: object
      properties:
        status:
          type: string
          enum: [ready, not_ready]
          description: Overall health status
        timestamp:
          type: string
          format: date-time
          description: ISO 8601 timestamp
        service:
          type: string
          description: Service name
        version:
          type: string
          description: Application version
        environment:
          type: string
          enum: [development, staging, production]
          description: Deployment environment
        dependencies:
          type: object
          properties:
            database:
              $ref: '#/components/schemas/DependencyHealth'
      required:
        - status
        - timestamp
        - service

    LivenessResponse:
      type: object
      properties:
        status:
          type: string
          enum: [alive]
          description: Liveness status
        timestamp:
          type: string
          format: date-time
          description: ISO 8601 timestamp
        service:
          type: string
          description: Service name
      required:
        - status
        - timestamp
        - service

    StartupResponse:
      type: object
      properties:
        status:
          type: string
          enum: [started, starting, failed]
          description: Startup status
        timestamp:
          type: string
          format: date-time
          description: ISO 8601 timestamp
        message:
          type: string
          description: Status message
        error:
          type: string
          description: Error message (if failed)
      required:
        - status
        - timestamp

    DependencyHealth:
      type: object
      properties:
        status:
          type: string
          enum: [healthy, unhealthy]
          description: Dependency health status
        type:
          type: string
          description: Dependency type
        error:
          type: string
          description: Error message (if unhealthy)

    # Telemetry Schemas
    TelemetryReading:
      type: object
      properties:
        well_id:
          type: string
          description: Well identifier
          example: WELL-001
        timestamp:
          type: string
          format: date-time
          description: ISO 8601 timestamp (optional, defaults to current time)
          example: '2025-11-20T14:30:00Z'
        flow_rate:
          type: number
          format: float
          description: Flow rate in barrels per day (BPD)
          example: 2500.5
        pip:
          type: number
          format: float
          description: Pump intake pressure in PSI
          example: 250.0
        motor_current:
          type: number
          format: float
          description: Motor current in amperes
          example: 45.2
        motor_temp:
          type: number
          format: float
          description: Motor temperature in Celsius
          example: 85.5
        vibration:
          type: number
          format: float
          description: Vibration level in mm/s
          example: 3.2
        vsd_frequency:
          type: number
          format: float
          description: VSD frequency in Hz
          example: 60.0
        flow_variance:
          type: number
          format: float
          description: Flow variance percentage
          example: 15.0
        torque:
          type: number
          format: float
          description: Torque in Nm
          example: 120.5
        gor:
          type: number
          format: float
          description: Gas-oil ratio
          example: 150.0
      required:
        - well_id
        - flow_rate
        - pip
        - motor_current
        - motor_temp
        - vibration
        - vsd_frequency
        - flow_variance
        - torque
        - gor

    TelemetryBatch:
      type: object
      properties:
        readings:
          type: array
          items:
            $ref: '#/components/schemas/TelemetryReading'
          description: Array of telemetry readings
          minItems: 1
          maxItems: 1000
      required:
        - readings

    TelemetryIngestResponse:
      type: object
      properties:
        success:
          type: boolean
          description: Operation success status
        telemetry_id:
          type: integer
          description: Database ID of ingested telemetry
        well_id:
          type: string
          description: Well identifier
        timestamp:
          type: string
          format: date-time
          description: Timestamp of telemetry reading

    BatchIngestResponse:
      type: object
      properties:
        success:
          type: boolean
          description: Operation success status
        batch_size:
          type: integer
          description: Number of readings ingested
        duration_ms:
          type: number
          format: float
          description: Ingestion duration in milliseconds

    TelemetryResponse:
      type: object
      properties:
        success:
          type: boolean
          description: Operation success status
        telemetry:
          $ref: '#/components/schemas/TelemetryReading'

    TelemetryHistoryResponse:
      type: object
      properties:
        success:
          type: boolean
          description: Operation success status
        well_id:
          type: string
          description: Well identifier
        hours:
          type: integer
          description: Hours of history requested
        count:
          type: integer
          description: Number of readings returned
        telemetry:
          type: array
          items:
            $ref: '#/components/schemas/TelemetryReading'

    WellSummary:
      type: object
      properties:
        well_id:
          type: string
          description: Well identifier
        period_hours:
          type: integer
          description: Summary period in hours
        reading_count:
          type: integer
          description: Number of readings in period
        flow_rate:
          $ref: '#/components/schemas/StatsSummary'
        pip:
          $ref: '#/components/schemas/StatsSummary'
        motor_current:
          $ref: '#/components/schemas/StatsSummary'
        motor_temp:
          $ref: '#/components/schemas/StatsSummary'
        vibration:
          $ref: '#/components/schemas/StatsSummary'

    StatsSummary:
      type: object
      properties:
        min:
          type: number
          format: float
        max:
          type: number
          format: float
        avg:
          type: number
          format: float
        stddev:
          type: number
          format: float

    WellSummaryResponse:
      type: object
      properties:
        success:
          type: boolean
          description: Operation success status
        summary:
          $ref: '#/components/schemas/WellSummary'

    # Diagnostic Schemas
    DiagnosticRequest:
      type: object
      properties:
        well_id:
          type: string
          description: Well identifier
        telemetry:
          $ref: '#/components/schemas/TelemetryReading'
        store_result:
          type: boolean
          description: Whether to store the diagnostic result
          default: true
      required:
        - well_id
        - telemetry

    DiagnosticResult:
      type: object
      properties:
        diagnosis:
          type: string
          enum:
            - NORMAL_OPERATION
            - GAS_LOCKING
            - PUMP_WEAR
            - MOTOR_OVERHEATING
            - HIGH_VIBRATION
            - LOW_INTAKE_PRESSURE
            - FLOW_INSTABILITY
          description: Diagnostic result type
        confidence:
          type: number
          format: float
          minimum: 0
          maximum: 1
          description: Confidence score (0-1)
        severity:
          type: string
          enum: [low, medium, high, critical]
          description: Issue severity level
        description:
          type: string
          description: Human-readable description
        root_cause:
          type: string
          description: Identified root cause
        recommended_actions:
          type: array
          items:
            type: string
          description: List of recommended actions
        expected_resolution_time:
          type: string
          description: Expected time to resolve
        telemetry_snapshot:
          $ref: '#/components/schemas/TelemetryReading'
        timestamp:
          type: string
          format: date-time
          description: Diagnostic timestamp

    DiagnosticResponse:
      type: object
      properties:
        success:
          type: boolean
          description: Operation success status
        well_id:
          type: string
          description: Well identifier
        diagnostic_id:
          type: integer
          description: Database ID of stored diagnostic (if stored)
        diagnostic:
          $ref: '#/components/schemas/DiagnosticResult'

    DiagnosticHistoryResponse:
      type: object
      properties:
        success:
          type: boolean
          description: Operation success status
        well_id:
          type: string
          description: Well identifier (if specific well)
        limit:
          type: integer
          description: Result limit
        count:
          type: integer
          description: Number of results returned
        diagnostics:
          type: array
          items:
            $ref: '#/components/schemas/DiagnosticResult'

    # Error Schema
    ErrorResponse:
      type: object
      properties:
        error:
          type: string
          description: Error type/code
        message:
          type: string
          description: Human-readable error message
        field:
          type: string
          description: Field name (for validation errors)
        details:
          type: object
          description: Additional error details
      required:
        - error
        - message

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT bearer token authentication (future implementation).
        Include the token in the Authorization header:
        `Authorization: Bearer <token>`

# Apply security globally (future)
# security:
#   - bearerAuth: []

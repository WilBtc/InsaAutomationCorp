version: '3.8'

services:
  # PostgreSQL with TimescaleDB for time-series data
  timescaledb:
    image: timescale/timescaledb:latest-pg15
    container_name: alkhorayef-timescaledb
    environment:
      POSTGRES_DB: esp_telemetry
      POSTGRES_USER: alkhorayef
      POSTGRES_PASSWORD: ${DB_PASSWORD:-AlkhorayefESP2025!}
      TS_TUNE_MAX_CONNECTIONS: 100
      TS_TUNE_MAX_BG_WORKERS: 8
    volumes:
      - timescale_data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init.sql:ro
    ports:
      - "5440:5432"
    networks:
      - alkhorayef-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U alkhorayef -d esp_telemetry"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis for caching and pub/sub
  redis:
    image: redis:7-alpine
    container_name: alkhorayef-redis
    command: redis-server --requirepass ${REDIS_PASSWORD:-RedisAlkhorayef2025!}
    ports:
      - "6389:6379"
    volumes:
      - redis_data:/data
    networks:
      - alkhorayef-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  # RabbitMQ for message queuing
  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: alkhorayef-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: alkhorayef
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-RabbitAlkhorayef2025!}
    ports:
      - "5672:5672"
      - "15672:15672"  # Management UI
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - alkhorayef-net
    restart: unless-stopped

  # Main API Service
  api:
    build:
      context: .
      dockerfile: Dockerfile
      network: host
    container_name: alkhorayef-api
    environment:
      DATABASE_URL: postgresql://alkhorayef:${DB_PASSWORD:-AlkhorayefESP2025!}@timescaledb:5432/esp_telemetry
      REDIS_URL: redis://:${REDIS_PASSWORD:-RedisAlkhorayef2025!}@redis:6379
      RABBITMQ_URL: amqp://alkhorayef:${RABBITMQ_PASSWORD:-RabbitAlkhorayef2025!}@rabbitmq:5672
      API_PORT: 8000
      GRAPHITI_ENABLED: "true"
      ML_MODELS_PATH: /app/models
    volumes:
      - ./:/app
      - ./models:/app/models
      - ./logs:/app/logs
    ports:
      - "8100:8000"
    depends_on:
      - timescaledb
      - redis
      - rabbitmq
    networks:
      - alkhorayef-net
    restart: unless-stopped
    command: python app.py

  # ML Service for predictions
  ml-service:
    build:
      context: .
      dockerfile: Dockerfile
      network: host
    container_name: alkhorayef-ml
    environment:
      DATABASE_URL: postgresql://alkhorayef:${DB_PASSWORD:-AlkhorayefESP2025!}@timescaledb:5432/esp_telemetry
      REDIS_URL: redis://:${REDIS_PASSWORD:-RedisAlkhorayef2025!}@redis:6379
      ML_SERVICE_PORT: 8001
    volumes:
      - ./:/app
      - ./ml-models:/app/models
      - ./logs:/app/logs
    ports:
      - "8101:8001"
    depends_on:
      - timescaledb
      - redis
    networks:
      - alkhorayef-net
    restart: unless-stopped
    command: python ml_service.py

  # Grafana for dashboards
  grafana:
    image: grafana/grafana:latest
    container_name: alkhorayef-grafana
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD:-GrafanaAlkhorayef2025!}
      GF_INSTALL_PLUGINS: grafana-clock-panel,grafana-simple-json-datasource
      GF_SERVER_ROOT_URL: https://alkhorayef.tail-scale.ts.net/grafana
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
      - ./grafana/dashboards:/var/lib/grafana/dashboards
    ports:
      - "3000:3000"
    depends_on:
      - timescaledb
    networks:
      - alkhorayef-net
    restart: unless-stopped

  # Nginx reverse proxy
  nginx:
    image: nginx:alpine
    container_name: alkhorayef-nginx
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/sites-enabled:/etc/nginx/sites-enabled:ro
      - ./static:/usr/share/nginx/html:ro
      - ./nginx/certs:/etc/nginx/certs:ro
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - api
      - grafana
      - ml-service
    networks:
      - alkhorayef-net
    restart: unless-stopped

  # Tailscale sidecar for secure access
  tailscale:
    image: tailscale/tailscale:latest
    container_name: alkhorayef-tailscale
    hostname: alkhorayef-esp
    environment:
      TS_AUTHKEY: ${TAILSCALE_AUTHKEY}
      TS_STATE_DIR: /var/lib/tailscale
      TS_USERSPACE: true
      TS_EXTRA_ARGS: --advertise-tags=tag:server --accept-dns=false
    volumes:
      - tailscale_data:/var/lib/tailscale
      - /dev/net/tun:/dev/net/tun
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    networks:
      - alkhorayef-net
    restart: unless-stopped

networks:
  alkhorayef-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.30.0.0/16

volumes:
  timescale_data:
  redis_data:
  rabbitmq_data:
  grafana_data:
  tailscale_data: